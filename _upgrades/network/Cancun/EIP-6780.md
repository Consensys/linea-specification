# EIP-6780: SELFDESTRUCT only in same transaction

## Impact

This will impact deployments and SELFDESTRUCT:
- TX_INIT (for deployment transactions)
- any CREATE/CREATE2 will have to log its ABS_TX_NUM of the current moment
- the account/ perspective (we need a new field "deployed in transaction X"
- the processing of the SELFDESTRUCT opcode (in particular the final account wiping row will depend on whether or not the contract in question was deployed in the same transaction or not.)

## Notes

Read through https://hackmd.io/@vbuterin/selfdestruct

## Approach

We can deal with this in the following way:
- add a binary `account/HAS_CODE_FIRST_IN_TXN` column
- the only constraints are that
    - this is binary
    - in the permutation realm we impose
```
If acp_PEEK_AT_ACCOUNT[i] ≡ 1 Then
    If acp_FIRST_IN_TXN[i] ≡ 1 Then acp_HAS_CODE_FIRST_IN_TRANSACTION[i] = acp_HAS_CODE[i]
    If acp_AGAIN_IN_TXN[i] ≡ 1 Then acp_HAS_CODE_FIRST_IN_TRANSACTION[i] = acp_HAS_CODE_FIRST_IN_TRANSACTION[i - 1]
```
- when processing a SELFDESTRUCT we act upon it like so:
    - `If account/HAS_CODE_FIRST_IN_TXN ≡ 0`
        - deleting the account at the end
            - raising the deployment number
            - erasing the balance
            - erasing the code
            - resetting the nonce
    - `If account/HAS_CODE_FIRST_IN_TXN ≡ 1` in the modified way
        - maintaining the balanace if `recipient == accountAddress`
        - not deleting account at the end, i.e. maintaining as is
            - the deployment number
            - the balance
            - the code
            - the nonce

## Test vectors

- interaction with CREATE (there should be some tests already)
- multitransaction test with DEPLOYMENT and CREATE
